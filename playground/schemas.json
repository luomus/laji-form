{
	"id": "MHL.1",
	"name": "Linjalaskenta",
	"language": "fi",
	"documentAdmin": "MA.398",
	"title": "Linjalaskentalomake",
	"collectionID": "HR.61",
	"description": "Linjalaskenta lomake",
	"features": [
		"MHL.featureNamedPlace",
		"MHL.featureAddingNamedPlacesNotAllowed",
		"MHL.featureRestrictAccess"
	],
	"printType": "MHL.printTypeLineTransect",
	"viewerType": "MHL.viewerTypeLineTransect",
	"uiSchema": {
		"ui:shortcuts": {
			"alt": {
				"fn": "help",
				"delay": 1
			},
			"alt+Enter": {
				"fn": "navigate"
			},
			"alt+shift+Enter": {
				"fn": "navigate",
				"reverse": true
			},
			"alt+ ": {
				"fn": "navigate"
			},
			"alt+shift+ ": {
				"fn": "navigate",
				"reverse": true
			},
			"alt+PageDown": {
				"fn": "navigateArray",
				"target": "root_gatherings",
				"targetLabel": "paikkaan"
			},
			"alt+PageUp": {
				"fn": "navigateArray",
				"reverse": true,
				"target": "root_gatherings",
				"targetLabel": "paikkaan"
			},
			"alt+n": {
				"fn": "navigateArray"
			},
			"alt+p": {
				"fn": "navigateArray",
				"reverse": true
			},
			"alt+Insert": {
				"fn": "insert"
			},
			"alt+i": {
				"fn": "insert"
			},
			"alt+Delete": {
				"fn": "delete"
			},
			"alt+d": {
				"fn": "delete"
			},
			"shift+Enter": {
				"fn": "insert",
				"target": "root_gatherings_%{root_gatherings.activeIdx}_units",
				"targetLabel": "havainto"
			},
			"alt+u": {
				"fn": "insert",
				"target": "root_gatherings_%{root_gatherings.activeIdx}_units",
				"targetLabel": "havainto"
			}
		},
		"ui:order": [
			"gatheringEvent",
			"gatherings"
		],
		"ui:field": "InjectField",
		"ui:options": {
			"injections": {
				"fields": [
					"editors"
				],
				"target": "gatheringEvent"
			}
		},
		"gatheringEvent": {
			"ui:field": "NestField",
			"classNames": "well well-sm",
			"ui:order": [
				"namedPlaceNotes",
				"*",
				"legPublic",
				"eventTime",
				"notes",
				"startPointDeviation",
				"routeDirectionAdhered",
				"startDistanceFromNECorner"
			],
			"ui:options": {
				"nests": {
					"legEditor": {
						"fields": [
							"leg",
							"editors"
						]
					},
					"eventTime": {
						"fields": [
							"dateBegin",
							"timeStart",
							"timeEnd"
						],
						"title": ""
					}
				}
			},
			"namedPlaceNotes": {
				"ui:widget": "textarea",
				"ui:options": {
					"rows": 3
				}
			},
			"legEditor": {
				"ui:field": "SplitField",
				"ui:options": {
					"splits": [
						{
							"fields": [
								"leg",
								"editors"
							],
							"name": "",
							"lg": 3,
							"md": 4,
							"sm": 5,
							"uiSchema": {
								"ui:field": "NestField",
								"ui:options": {
									"nests": {
										"": {
											"fields": [
												"leg",
												"editors"
											],
											"title": ""
										}
									}
								},
								"": {
									"ui:field": "DependentBooleanField",
									"ui:options": {
										"booleanField": "editors",
										"booleanDefiner": "leg"
									},
									"uiSchema": {
										"ui:field": "ArrayCombinerField",
										"uiSchema": {
											"ui:field": "TableField",
											"ui:options": {
												"specialRules": "legEditors"
											},
											"items": {
												"ui:field": "ContextInjectionField",
												"ui:options": {
													"injections": {
														"/ui:options/rules/0/regexp": "/creator"
													}
												},
												"uiSchema": {
													"ui:field": "DependentDisableField",
													"ui:options": {
														"rules": [
															{
																"disableDefiner": "leg",
																"disableField": "editors",
																"regexp": "creator is injected here",
																"inlineHelp": "Sinulla täytyy olla muokkausoikeus.",
																"disabledValueToDisplay": true
															},
															{
																"disableDefiner": "leg",
																"disableField": "editors",
																"regexp": "^((?!(MA\\.\\d)).)*$"
															}
														]
													}
												},
												"leg": {
													"ui:widget": "AutosuggestWidget",
													"ui:options": {
														"autosuggestField": "friends",
														"allowNonsuggestedValue": true,
														"suggestionReceive": "key",
														"preventTypingPattern": "^MA\\.\\d+$"
													}
												},
												"editors": {
													"ui:help": "Jos syötät havainnon tekijäksi tunnistetun käyttäjän, ja käyttäjä on lisännyt sinut kaveriksesi, voit antaa kyseiselle käyttäjälle oikeuden muokata tätä retkikertomusta. Lisäksi tämän retkikertomuksen havainnot näkyvät kyseiselle käyttäjälle hänen omien havaintojensa joukossa.",
													"ui:options": {
														"allowUndefined": false
													}
												}
											}
										}
									}
								}
							}
						}
					]
				}
			},
			"eventTime": {
				"ui:field": "GridLayoutField",
				"ui:options": {
					"rows": [
						[
							"dateBegin",
							"timeStart",
							"timeEnd"
						]
					],
					"lg": {
						"dateBegin": 3,
						"timeStart": 2,
						"timeEnd": 2
					},
					"md": {
						"dateBegin": 4,
						"timeStart": 2,
						"timeEnd": 2
					},
					"sm": {
						"dateBegin": 5,
						"timeStart": 3,
						"timeEnd": 3
					},
					"xs": 12
				},
				"dateBegin": {
					"ui:widget": "DateWidget",
					"ui:options": {
						"showButtons": true
					}
				},
				"timeStart": {
					"ui:widget": "TimeWidget"
				},
				"timeEnd": {
					"ui:widget": "TimeWidget"
				}
			},
			"legPublic": {
				"ui:options": {
					"allowUndefined": false,
					"invert": true
				}
			},
			"notes": {
				"ui:widget": "textarea",
				"ui:options": {
					"rows": 2
				}
			},
			"startDistanceFromNECorner": {
				"classNames": "col-sm-4 col-lg-3"
			},
			"startPointDeviation": {
				"classNames": "col-sm-3 col-lg-2",
				"ui:help": "Mikäli reitin laskenta aloitettiin muusta kuin määritellystä aloituspisteestä, ilmoita tässä kentässä poikkeama metreinä aloituspisteestä tavalliseen kiertosuuntaan."
			},
			"routeDirectionAdhered": {
				"classNames": "col-sm-3 col-lg-2",
				"ui:options": {
					"allowUndefined": false
				}
			}
		},
		"gatherings": {
			"ui:field": "MapArrayField",
			"ui:help": "Aloita havaintojen ilmoittaminen piirtämällä havaintoalue kartalle",
			"ui:options": {
				"geometryField": "geometry",
				"geometryMapper": "lineTransect",
				"topOffset": 50,
				"bottomOffset": 50,
				"mapSizes": {
					"lg": 4,
					"md": 4,
					"sm": 6,
					"xs": 6
				},
				"popupFields": [
					{
						"mapper": "unitTaxon"
					},
					{
						"field": "sex"
					}
				],
				"mapOptions": {
					"tileLayerName": "maastokartta"
				}
			},
			"uiSchema": {
				"ui:field": "SingleActiveArrayField",
				"ui:options": {
					"renderer": "pager",
					"canAdd": false,
					"popupFields": [
						{
							"field": "units",
							"mapper": "units"
						}
					]
				},
				"items": {
					"ui:field": "NestField",
					"ui:options": {
						"nests": {
							"placeWrapper": {
								"title": "Havaintopaikan tiedot",
								"fields": [
									"habitatClassification",
									"skipped",
									"timeStart",
									"timeEnd"
								]
							}
						}
					},
					"ui:order": [
						"*",
						"units"
					],
					"placeWrapper": {
						"classNames": "well well-sm",
						"ui:field": "GridLayoutField",
						"ui:options": {
							"rows": [
								[
									"habitatClassification",
									"skipped"
								],
								[
									"timeStart",
									"timeEnd"
								]
							],
							"lg": 2,
							"md": 2,
							"sm": 4,
							"xs": 12
						},
						"skipped": {
							"ui:options": {
								"allowUndefined": false
							}
						},
						"timeStart": {
							"ui:widget": "TimeWidget"
						},
						"timeEnd": {
							"ui:widget": "TimeWidget"
						}
					},
					"units": {
						"ui:field": "AutoArrayField",
						"ui:options": {
							"autofocus": true,
							"confirmDelete": true,
							"deleteCorner": true,
							"buttons": [
								{
									"fn": "add",
									"label": "Lisää havainto"
								},
								{
									"fn": "copy",
									"label": "Kopioi havainto",
									"type": "blacklist",
									"filter": [
										"/identifications/taxon",
										"/identifications/taxonID",
										"unitType",
										"individualCount",
										"notes",
										"/unitGathering/geometry",
										"images"
									]
								}
							]
						},
						"items": {
							"ui:field": "ContextInjectionField",
							"classNames": "well well-sm",
							"ui:options": {
								"injections": {
									"/ui:options/formID": "/formID"
								}
							},
							"uiSchema": {
								"ui:field": "UnitRapidField",
								"ui:options": {
									"shorthandField": "shortHandText",
									"injectButtons": true
								},
								"uiSchema": {
									"ui:field": "FlatField",
									"ui:options": {
										"fields": [
											"identifications"
										]
									},
									"uiSchema": {
										"ui:field": "ScopeField",
										"ui:options": {
											"includeAdditionalFieldsChooserButton": true,
											"fields": [
												"shortHandText",
												"/identifications/taxonID",
												"/identifications/taxon",
												"lineTransectObsType",
												"lineTransectRouteFieldType",
												"individualCount",
												"pairCount"
											],
											"fieldScopes": {
												"unitType": {
													"*": {
														"additionalFields": [
															"notes",
															"lineTransectPairCountChanged"
														]
													}
												},
												"lineTransectObsType": {
													"MY.lineTransectObsTypeSeenBrood": {
														"fields": [
															"broodSize",
															"pairCount"
														]
													},
													"MY.lineTransectObsTypeSeenNest": {
														"fields": [
															"broodSize",
															"pairCount"
														]
													}
												}
											}
										},
										"uiSchema": {
											"ui:field": "AutosuggestField",
											"ui:options": {
												"autosuggestField": "taxon",
												"allowNonsuggestedValue": true,
												"suggestionInputField": "/identifications/taxon",
												"suggestionValueField": "/identifications/taxonID",
												"suggestionReceivers": {
													"/identifications/taxon": "value",
													"unitType": "$taxonGroup",
													"/identifications/taxonID": "key"
												},
												"inputTransformer": {
													"regexp": "^(.*)\\?$",
													"transformations": {
														"taxonConfidence": "MY.taxonConfidenceUnsure"
													}
												}
											},
											"uiSchema": {
												"ui:field": "InputTransformerField",
												"ui:options": {
													"rules": {
														"pairCount": {
															"regexp": "",
															"transformations": {
																"lineTransectPairCountChanged": true
															}
														}
													}
												},
												"uiSchema": {
													"ui:field": "GridLayoutField",
													"ui:options": {
														"lg": 2,
														"md": 2,
														"sm": 4,
														"xs": 12,
														"rows": [
															[
																"shortHandText",
																"/identifications/taxon",
																"lineTransectObsType",
																"lineTransectRouteFieldType",
																"individualCount",
																"pairCount"
															]
														]
													},
													"shortHandText": {
														"ui:readonly": true,
														"ui:help": "<div> <strong>Kirjoita pikakirjoitukseen LAJI (a) (Lukumäärä) Koodi (A/P)</strong> <p> <table class=\"table table-condensed\"> <thead> <tr> <th>Koodi</th><th>Havainnon laatu</th><th>Ilmoitettava lukumäärä</th> </tr> </thead> <tbody> <tr> <td>x</td><td>Laulava</td><td>Yksilömäärä</td> </tr> <tr> <td>v</td><td>Muuten ääntelevä</td><td>Yksilömäärä</td> </tr> <tr> <td>o</td><td>Näköhavainto</td><td>Yksilömäärä</td> </tr> <tr> <td>k</td><td>Koiras</td><td>Yksilömäärä</td> </tr> <tr> <td>n</td><td>Naaras</td><td>Yksilömäärä</td> </tr> <tr> <td>y</td><td>Ylilentävä</td><td>Yksilömäärä</td> </tr> <tr> <td>a luku o</td><Td>Parvi</Td><td>Yksilömäärä</td> </tr> <tr> <td>a luku y</td><td>Lentoparvi</td><td>Yksilömäärä</td> </tr> <tr> <td>pari</td><td>Pari</td><td>Parimäärä</td> </tr> <tr> <td>poikue</td><td>Poikue</td><td>Parimäärä</td> </tr> <tr> <td>pesä</td><td>Pesä</td><td>Parimäärä</td> </tr> </tbody> </table> </p> <p> <table class=\"table table-condensed\"> <thead> <tr> <th>LAJI</th><th>Lajin kaksi- tai kuusikirjaiminen koodi. Pakollinen.</th> </tr> </thead> <tbody> <tr> <td>a</td><td>Jos kyseessä on parvihavainto, lukumäärän eteen kirjoitetaan a. Muuten a jätetään kirjoittamatta. </td></tr> <tr> <td>Lukumäärä</td><td>Yksilömäärä tai koodeille \"pari\", \"poikue\", \"pesä\" parimäärä. Jos jätetään kirjoittamatta, lukumääräksi tulee 1. </td></tr> <tr> <td>Koodi</td><td>Katso taulukko alta. Pakollinen. </td></tr> <tr> <td>A/P</td><td>A = Apusarka, P = Pääsarka. Jos jätetään kirjoittamatta, saraksi tulee A. </td></tr> </tbody> </table> </p> <p> Voit käyttää suuria tai pieniä kirjaimia. Voit käyttää välilyöntejä tai kirjoittaa kaiken yhteen. </p> <p> Esimerkkejä: <i>TTX, RRvp, pt2xp, ec2y, CSa6y, CORNIX O P, cornixop, TM2pariP, PD3k</i> </p> </div>"
													},
													"/identifications/taxonID": {
														"ui:widget": "HiddenWidget"
													},
													"/identifications/detDate": {
														"ui:widget": "DateWidget"
													},
													"unitType": {
														"ui:field": "HiddenField"
													},
													"/unitGathering/geometry": {
														"ui:field": "HiddenField"
													},
													"lineTransectPairCountChanged": {
														"ui:options": {
															"allowUndefined": false
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	},
	"attributes": {
		"id": "MHL.1"
	},
	"schema": {
		"type": "object",
		"properties": {
			"editors": {
				"type": "array",
				"title": "Muokkausoikeus",
				"uniqueItems": true,
				"items": {
					"type": "string"
				}
			},
			"gatheringEvent": {
				"type": "object",
				"title": "",
				"properties": {
					"namedPlaceNotes": {
						"type": "string",
						"title": "Reitin kuvaus"
					},
					"startDistanceFromNECorner": {
						"type": "string",
						"title": "Lähtöpisteen etäisyys reitin koillisnurkasta (m)"
					},
					"leg": {
						"type": "array",
						"title": "Havainnoijat",
						"uniqueItems": true,
						"items": {
							"type": "string"
						}
					},
					"legPublic": {
						"type": "boolean",
						"title": "Havainnoijien nimet salataan",
						"default": true
					},
					"dateBegin": {
						"type": "string",
						"title": "Alku"
					},
					"timeStart": {
						"type": "string",
						"title": "Aloitusaika"
					},
					"timeEnd": {
						"type": "string",
						"title": "Lopetusaika"
					},
					"startPointDeviation": {
						"type": "integer",
						"title": "Aloituspisteen poikkeama (m)"
					},
					"routeDirectionAdhered": {
						"type": "boolean",
						"title": "Reitin kiertosuuntaa noudatettiin",
						"default": true
					},
					"notes": {
						"type": "string",
						"title": "Lisätiedot laskennasta (esimerkiksi muutokset reittiin jne.)"
					}
				},
				"required": []
			},
			"gatherings": {
				"type": "array",
				"title": "Paikka",
				"uniqueItems": true,
				"items": {
					"type": "object",
					"properties": {
						"habitatClassification": {
							"type": "string",
							"title": "Pääsaran biotooppi"
						},
						"skipped": {
							"type": "boolean",
							"title": "Jätetty väliin",
							"default": false
						},
						"timeStart": {
							"type": "string",
							"title": "Aloitusaika"
						},
						"timeEnd": {
							"type": "string",
							"title": "Lopetusaika"
						},
						"units": {
							"type": "array",
							"title": "Havainnot",
							"uniqueItems": true,
							"items": {
								"type": "object",
								"properties": {
									"unitType": {
										"type": "array",
										"title": "Näytteen tyyppi",
										"uniqueItems": true,
										"items": {
											"type": "string"
										}
									},
									"notes": {
										"type": "string",
										"title": "Lisätiedot"
									},
									"individualCount": {
										"type": "integer",
										"title": "Yksilömäärä"
									},
									"identifications": {
										"type": "array",
										"uniqueItems": true,
										"items": {
											"type": "object",
											"properties": {
												"taxon": {
													"type": "string",
													"title": "Laji"
												},
												"taxonID": {
													"type": "string",
													"title": "Taksonin tunniste"
												}
											},
											"required": []
										}
									},
									"shortHandText": {
										"type": "string",
										"title": "Pika"
									},
									"lineTransectObsType": {
										"type": "string",
										"title": "Laatu",
										"enum": [
											"",
											"MY.lineTransectObsTypeSong",
											"MY.lineTransectObsTypeOtherSound",
											"MY.lineTransectObsTypeSeen",
											"MY.lineTransectObsTypeSeenMale",
											"MY.lineTransectObsTypeSeenFemale",
											"MY.lineTransectObsTypeFlyingOverhead",
											"MY.lineTransectObsTypeFlock",
											"MY.lineTransectObsTypeFlockFlyingOverhead",
											"MY.lineTransectObsTypeSeenPair",
											"MY.lineTransectObsTypeSeenBrood",
											"MY.lineTransectObsTypeSeenNest"
										],
										"enumNames": [
											"",
											"Laulava",
											"Muuten ääntelevä",
											"Näköhavainto",
											"Koiras",
											"Naaras",
											"Ylilentävä",
											"Parvi",
											"Lentoparvi",
											"Pari",
											"Poikue",
											"Pesä"
										]
									},
									"lineTransectRouteFieldType": {
										"type": "string",
										"title": "Sarka",
										"enum": [
											"",
											"MY.lineTransectRouteFieldTypeInner",
											"MY.lineTransectRouteFieldTypeOuter"
										],
										"enumNames": [
											"",
											"P - Pääsarka",
											"A - Apusarka"
										]
									},
									"pairCount": {
										"type": "integer",
										"title": "Parimäärä",
										"default": 1
									},
									"broodSize": {
										"type": "integer",
										"title": "Pesuekoko"
									},
									"lineTransectPairCountChanged": {
										"type": "boolean",
										"title": "Parimäärä muuttettu",
										"default": false
									}
								},
								"required": []
							},
							"minItems": 1
						},
						"geometry": {
							"type": "object",
							"properties": {},
							"title": "MY.geometry"
						}
					},
					"required": []
				}
			}
		},
		"required": []
	},
	"validators": {
		"gatheringEvent": {
			"properties": {
				"leg": {
					"presence": {
						"message": "Vähintään yksi havainnoija täytyy ilmoittaa."
					}
				},
				"dateBegin": {
					"presence": true,
					"date": {
						"earliest": "1915-05-01",
						"latest": "now"
					},
					"monthDay": {
						"earliestMonth": 5,
						"earliestDay": 1,
						"latestMonth": 7,
						"latestDay": 31
					}
				},
				"timeStart": {
					"time": {
						"earliestHour": 1,
						"latestHour": 6
					},
					"crossCheck": {
						"check": "timeEnd",
						"message": "Aloitus aika tarvitaan kun lopetusaika on ilmoitettu"
					}
				},
				"timeEnd": {
					"time": {
						"earliestHour": 1,
						"latestHour": 13,
						"latestMinute": 59
					},
					"compareNumerically": {
						"greaterThan": "timeStart",
						"message": "Loppuajan tulee olla alkuaikaa myöhemmin"
					}
				},
				"routeDirectionAdhered": {
					"presence": true
				}
			},
			"presence": true
		},
		"gatherings": {
			"items": {
				"properties": {
					"habitatClassification": {
						"transectBiotope": {
							"notString": "Value in %{key} is not of type strin",
							"invalidBiotop": "Biotope should be one of K,M,S,L,J,P,H,R,N,V,A,T or X but '%{value}' given",
							"invalidFocus": "Invalid second character should be one of %{key}, but got %{value}",
							"invalidSize": "Invalid measurement given should be %{key}, but got %{value}",
							"invalidK": "When A given number should be between 1-6. Now '%{value}' given.",
							"invalidA": "When K given number should be between 2-35. Now '%{value}' given.",
							"invalidX": "Invalid biotope other. Should only contain focusing character after X and nothing else",
							"tooLong": "Biotope code has some extra values that shouldn't be there. Place use notes fields instead",
							"tooShort": "Biotope code is too sort!"
						}
					},
					"timeStart": {
						"time": {
							"earliestHour": 1,
							"latestHour": 6
						},
						"crossCheck": {
							"check": "timeEnd",
							"message": "Aloitus aika tarvitaan kun lopetusaika on ilmoitettu"
						}
					},
					"timeEnd": {
						"time": {
							"earliestHour": 1,
							"latestHour": 13,
							"latestMinute": 59
						},
						"compareNumerically": {
							"greaterThan": "timeStart",
							"message": "Loppuajan tulee olla alkuaikaa myöhemmin"
						}
					},
					"units": {
						"items": {
							"properties": {
								"individualCount": {
									"numericality": {
										"onlyInteger": true,
										"greaterThanOrEqualTo": 1,
										"lessThanOrEqualTo": 2000
									},
									"compareNumerically": {
										"greaterThan": 1,
										"onlyWhenAttrIn": {
											"lineTransectObsType": [
												"MY.lineTransectObsTypeFlock",
												"MY.lineTransectObsTypeFlockFlyingOverhead"
											]
										},
										"message": "Individual count has to be greater that 1 when flock seen"
									}
								},
								"pairCount": {
									"numericality": {
										"onlyInteger": true,
										"greaterThanOrEqualTo": 1,
										"lessThanOrEqualTo": 2000
									},
									"compareNumerically": {
										"lessThanOrEqualTo": "individualCount",
										"message": "Pair count cannot be greater than individual count"
									}
								}
							}
						}
					},
					"geometry": {
						"geometry": {
							"requireShape": true,
							"message": {
								"missingGeometries": "Paikalla täytyy olla vähintään yksi kuvio."
							}
						}
					}
				}
			},
			"presence": {
				"message": "Vähintään yksi paikka täytyy ilmoittaa."
			}
		}
	},
	"uiSchemaContext": {
		"creator": "MA.308",
		"formID": "MHL.1"
	},
	"formData": {
	  "gatheringEvent": {
		"leg": [
		  "MA.308"
		],
		"legPublic": true,
		"dateBegin": "2017-05-23"
	  },
	  "editors": [],
	  "secureLevel": "MX.secureLevelNone",
	  "gatherings": [
		{
		  "images": [],
		  "units": [
			{
			  "recordBasis": "MY.recordBasisHumanObservation",
			  "unitType": [
				"MVL.2"
			  ],
			  "taxonConfidence": "MY.taxonConfidenceSure",
			  "images": [],
			  "unitGathering": {
				"geometry": {}
			  },
			  "identifications": [
				{
				  "taxon": "ass",
				  "taxonID": "MX.47092"
				}
			  ]
			}
		  ],
		  "geometry": {
			"type": "GeometryCollection",
			"geometries": [
			  {
				"type": "Point",
				"coordinates": [
				  27.170841451122595,
				  64.54526624516768
				]
			  }
			]
		  }
		}
	  ]
	}
}

